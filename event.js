!function(window){function shuffle(array){for(var temporaryValue,randomIndex,currentIndex=array.length;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex-=1,temporaryValue=array[currentIndex],array[currentIndex]=array[randomIndex],array[randomIndex]=temporaryValue;return array}function indexOfObject(array,object,uniqueProp){for(var i=0;i<array.length;i++)if(array[i][uniqueProp]===object[uniqueProp])return i;return-1}var DEBUG,LAST_FETCH,LAST_PHOTO,MAX_SEEN_LIST_SIZE,PHOTOS,REJECTED,SEEN_LIST,FETCHED_DATE,HISTORY,MAX_HISTORY_LIST_SIZE,log;DEBUG=!1,MAX_SEEN_LIST_SIZE=500,MAX_HISTORY_LIST_SIZE=10,LAST_FETCH="lastFetch",LAST_PHOTO="lastPhoto",FETCHED_DATE="fetchedDate",PHOTOS="photos",REJECTED="rejected",SEEN_LIST="seenPhotos",HISTORY="history",window.FlickrTabEvents={init:function(){localStorage.getItem(LAST_FETCH)||this.fetchInterestingPhotos(),chrome.runtime.onMessage.addListener(this.queueJob.bind(this))},queueJob:function(request,sender,sendResponse){sender.tab&&"chrome://newtab/"===sender.tab.url?this[request.func]?this[request.func].apply(this,request.args):log("[QJ] unrecognized function:",request.func):log("[QJ] unrecognized sender",sender.tab&&sender.tab.url),sendResponse("ok")},cacheNextPhotos:function(){var cachedPhotos,img,index,nowPhotoIndex,photos,photo;nowPhotoIndex=Number(localStorage.getItem(LAST_PHOTO))||0,cachedPhotos=localStorage.getItem(PHOTOS),photos=JSON.parse(cachedPhotos);for(var i=0;10>i;i++)index=nowPhotoIndex+i,photo=photos[index%photos.length],img=new Image,img.src=photo.url_l||photo.url_m},fetchInterestingPhotos:function(){var i,baseURL,url,fetchedDate,computeMoment,maxSafeDate,requiredLatestDate,daysDifference,safeDays,exploreDays=[],numberOfExploreCalls=0,dailyLists={},NUM_DAYS=7,momentToday=moment();for(fetchedDate=JSON.parse(localStorage.getItem(FETCHED_DATE)),fetchedDate?(moment(fetchedDate.earliest).diff(moment("2007-01-01"),"days")<0&&(fetchedDate.latest=momentToday.format("YYYY-MM-DD"),fetchedDate.earliest=fetchedDate.latest),maxSafeDate=momentToday.subtract(4,"days"),requiredLatestDate=moment(fetchedDate.latest).add(NUM_DAYS,"days"),daysDifference=maxSafeDate.diff(requiredLatestDate,"days")-1,-NUM_DAYS>daysDifference&&(daysDifference=-NUM_DAYS),safeDays=NUM_DAYS+daysDifference):(fetchedDate={},fetchedDate.latest=momentToday.subtract(4+NUM_DAYS,"days").format("YYYY-MM-DD"),fetchedDate.earliest=fetchedDate.latest,daysDifference=NUM_DAYS,safeDays=NUM_DAYS),computeMoment=moment(fetchedDate.latest),i=0;NUM_DAYS>i&&safeDays>i;i++)exploreDays.push(computeMoment.add(1,"days").format("YYYY-MM-DD"));if(exploreDays.length&&(fetchedDate.latest=exploreDays[exploreDays.length-1]),0>daysDifference){for(computeMoment=moment(fetchedDate.earliest),i=-1;i>=daysDifference;i--)exploreDays.push(computeMoment.add(-1,"days").format("YYYY-MM-DD"));fetchedDate.earliest=exploreDays[exploreDays.length-1]}localStorage.setItem(FETCHED_DATE,JSON.stringify(fetchedDate)),baseURL="https://api.flickr.com/services/rest/?method=flickr.interestingness.getList&api_key=3103129f7e79ace086511b6c18fa212f&format=json&nojsoncallback=1&extras=url_n,url_l,url_m,media,path_alias&per_page=70",exploreDays.forEach(function(exploreDay,index){var xmlhttp=new XMLHttpRequest;url=baseURL+"&date="+exploreDay,xmlhttp.day=index,xmlhttp.exploreDay=exploreDay,xmlhttp.onreadystatechange=function(){this.readyState===XMLHttpRequest.DONE&&this.status>=200&&this.status<300&&(dailyLists[this.day]=JSON.parse(this.response).photos.photo,numberOfExploreCalls++,numberOfExploreCalls===NUM_DAYS&&FlickrTabEvents._cachePhotosData(dailyLists,this.exploreDay))},xmlhttp.open("GET",url,!0),xmlhttp.send()})},updateHistory:function(photo){var photoIndex,history=JSON.parse(localStorage.getItem(HISTORY));history||(history=[]),photoIndex=indexOfObject(history,photo,"id"),photoIndex>-1&&history.splice(photoIndex,1),history.unshift(photo),history.length>MAX_HISTORY_LIST_SIZE&&history.splice(-1,history.length-MAX_HISTORY_LIST_SIZE),localStorage.setItem(HISTORY,JSON.stringify(history)),this.markPhotoSeen(photo.id)},markPhotoSeen:function(photoId){var i,seenList;seenList=this._getSeenList();for(i in seenList)if(photoId===seenList[i])return;for(;seenList.length>MAX_SEEN_LIST_SIZE;)seenList.shift();seenList.push(photoId),localStorage.setItem(SEEN_LIST,JSON.stringify(seenList))},_getSeenList:function(){var seenList=JSON.parse(localStorage.getItem(SEEN_LIST));return Array.isArray(seenList)||(seenList=[]),seenList},_cachePhotosData:function(dailyLists,exploreDay){var p,photo,pruned,ratio,cachedPhotos=[],dedupe={},shuffled=[],rejectedPhotos=[];pruned=this._prune(dailyLists,this._getSeenList());for(p in pruned)shuffled=shuffled.concat(shuffle(pruned[p]));for(p in shuffled)photo=shuffled[p],ratio=photo.width_m/photo.height_m,photo.photoRatio=ratio,photo.exploreDay=exploreDay,"video"===photo.media?rejectedPhotos.push(photo):dedupe[photo.id]?log("[_cPD] dupe id",photo.id):(cachedPhotos.push(photo),dedupe[photo.id]=!0);localStorage.setItem(PHOTOS,JSON.stringify(cachedPhotos)),localStorage.setItem(REJECTED,JSON.stringify(rejectedPhotos)),localStorage.setItem(LAST_FETCH,Date.now()),localStorage.setItem(LAST_PHOTO,0),this.cacheNextPhotos()},_prune:function(dailyLists,seenList){var id,order,allPhotos={},dedupeHash={},inNewLists={},newLists=[],seenButKept=[];for(var i in seenList)dedupeHash[seenList[i]]=!0;order=Object.keys(dailyLists).sort(function(a,b){return b-a});for(var o in order){var dayList,list,photo;list=dailyLists[order[o]],dayList=[];for(var p in list)photo=list[p],id=photo.id,allPhotos[id]=photo,dedupeHash[id]||(dayList.push(photo),dedupeHash[id]=!0,inNewLists[id]=!0);newLists.push(dayList)}for(id in allPhotos)inNewLists[id]||seenButKept.push(allPhotos[id]);return newLists.push(seenButKept),newLists}},log=function(){},DEBUG&&(log=function(){var args,time;args=1<=arguments.length?[].slice.call(arguments,0):[],time=(new Date%6e4/1e3).toFixed(3),args.unshift(time),console.log.apply(console,args)},log("begin page load"),"undefined"!=typeof module&&(console.log("module"),window.document={createElement:function(){return{}}},window.document.body={appendChild:function(){}},module.exports=window.FlickrTabEvents));var script=window.document.createElement("script");script.src="moment.min.js",script.onload=function(){window.FlickrTabEvents.init()},window.document.body.appendChild(script)}(this);