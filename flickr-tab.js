(function(){"use strict";if(!window.FlickrTab){var CACHE_HIT,CACHE_MISS,DEBUG,DEBUG_OFFLINE,FORCE_OFFLINE,LAST_FETCH,LAST_PHOTO,PHOTOS,PRELOADS,randInt,hasPhotoToDisplay,log,LAST_VIEWED_PHOTO,HISTORY;DEBUG=!1,CACHE_MISS=0,CACHE_HIT=1,FORCE_OFFLINE=!1,LAST_FETCH="lastFetch",PHOTOS="photos",LAST_PHOTO="lastPhoto",DEBUG_OFFLINE="forceOffline",HISTORY="history",PRELOADS=[{by:"Andrés Nieto Porras",title:"Svartifoss",link:"https://www.flickr.com/photos/anieto2k/15687195488/"},{by:"Digo_Souza",title:"Flower (Macro Photography)",link:"https://www.flickr.com/photos/caochopp/6765007193/"},{by:"Roger Nelson",title:"Admiring the view",link:"https://www.flickr.com/photos/25646954@N00/1097698638/"},{by:"Julien Belli",title:"Arrow",link:"https://www.flickr.com/photos/julienbelli/14694799896/"},{by:"Rita Willaert",title:"Danmark O, Fohn Fjord,  Renodde.70°N/26°W",link:"https://www.flickr.com/photos/14417999@N00/76566707/"}],hasPhotoToDisplay=!1,DEBUG&&(FORCE_OFFLINE=localStorage.getItem(DEBUG_OFFLINE)),window.FlickrTab={ywaParams:"?src=ctab",numberOfExploreCalls:0,init:function(){if(this.setTitle(),this.setYWAParams(),this.initHistory(),!navigator.onLine||FORCE_OFFLINE)return void this.showOfflinePage();var cachedPhotos,photos;if(this.photoDiv=document.getElementById("photo"),this.cacheState()===CACHE_MISS)return log("[cache] MISS!"),this.showOfflinePage(),void this.queueJob("fetchInterestingPhotos");try{cachedPhotos=localStorage.getItem(PHOTOS),photos=JSON.parse(cachedPhotos),this.renderLiveTab(photos,this.selectRandomPhoto.bind(this))}catch(error){log(error),this.showOfflinePage()}},setTitle:function(){var title=document.getElementsByTagName("title")[0];title.innerText=chrome.i18n.getMessage("newTabTitle")},showOfflinePage:function(){log("offline mode");var img,id,link,fTitle,photo;id=randInt(PRELOADS.length),photo=PRELOADS[id],log(id,photo),img=document.getElementById("thumbnail-image"),img.src="/preload-"+id+".jpg",link=document.getElementById("thumbnail-link"),link.href=photo.link,link.style.backgroundImage="url(/preload-"+id+".jpg)",link.style.backgroundSize="cover",fTitle=document.getElementsByClassName("title-link")[0],fTitle.className="title-link",fTitle.href=link.href,fTitle.innerText=photo.title},cacheState:function(){var cachedLastFetch,lastFetch;return(cachedLastFetch=Number(localStorage.getItem(LAST_FETCH)))?(lastFetch=new Date(cachedLastFetch),log({lastFetch:lastFetch,cachedLastFetch:cachedLastFetch}),CACHE_HIT):CACHE_MISS},renderLiveTab:function(photos,callback){chrome.tabs.getCurrent(function(tab){callback(tab,photos)})},saveLastViewedPhoto:function(id,photo){if(id&&photo){var viewedLast={id:id,photo:photo};localStorage.setItem("lastViewedItem",JSON.stringify(viewedLast)),LAST_VIEWED_PHOTO=viewedLast}},isInSameTab:function(id){if(1===window.history.length)return{status:!1};if(void 0!==LAST_VIEWED_PHOTO&&LAST_VIEWED_PHOTO.id===id)return{status:!0,photo:LAST_VIEWED_PHOTO.photo};var lastViewedItemInStorage=localStorage.getItem("lastViewedItem"),result={status:!1};if(lastViewedItemInStorage){var lastViewedItemInStorageJSON=JSON.parse(lastViewedItemInStorage);void 0!==lastViewedItemInStorageJSON&&lastViewedItemInStorageJSON.id===id&&(result={status:!0,photo:lastViewedItemInStorageJSON.photo})}return result},selectRandomPhoto:function(tab,photos){console.log("tab asking",tab.id+" in "+tab.windowId);var nowPhotoIndex,photo,photoRatio,tabRatio,percentageDifference,usablePhoto=!1;if(!hasPhotoToDisplay){if(!photos||0===photos.length)return void FlickrTab.showOfflinePage();for(tabRatio=tab.width/tab.height,nowPhotoIndex=Number(localStorage.getItem(LAST_PHOTO));nowPhotoIndex<photos.length;){if(photo=photos[nowPhotoIndex++],!photo.photoRatio){usablePhoto=!0;break}if(photoRatio=photo.photoRatio,percentageDifference=Math.abs(photoRatio-tabRatio)/tabRatio,.14>=percentageDifference){usablePhoto=!0;break}}if(!usablePhoto)return this.queueJob("fetchInterestingPhotos"),void FlickrTab.showOfflinePage();nowPhotoIndex>=photos.length&&(this.queueJob("fetchInterestingPhotos"),nowPhotoIndex=0),localStorage.setItem(LAST_PHOTO,nowPhotoIndex),this.queueJob("cacheNextPhotos"),log(nowPhotoIndex,photo);var isSameTab=this.isInSameTab(tab.id+"-"+tab.windowId);return isSameTab.status&&isSameTab.status===!0?(console.log("same tab asking!",tab,isSameTab.photo),this.renderRandomPhoto(tab,isSameTab.photo)):this.renderRandomPhoto(tab,photo)}},renderRandomPhoto:function(tab,photo){function showIframe(){if(slowNetwork)return void iframe.remove();if("ready"!==iframe.className){var footer=document.getElementsByClassName("footer")[0],flogo=document.querySelector(".flickr-logo");iframe.className="ready",setTimeout(function(){link.className.indexOf("hide")>-1||(link.className+=" hide",footer.className+=" hide",flogo.className+=" hide")},500)}}function receiveMessage(event){var data=event.data.split(",");event.origin.match(/\/www.flickr.com$/)&&data[0]===photo.id&&"loaded"===data[1]&&(log("received data from iframe",event.data),counter+=1,2===counter&&showIframe())}var fTitle,iframe,img,link,offlineCheck,photoUrl,photoRatio,tabRatio,pathAlias,slowNetwork=!1;this.saveLastViewedPhoto(tab.id+"-"+tab.windowId,photo),offlineCheck=setTimeout(function(){log("slow connection, force offline mode"),slowNetwork=!0,fTitle.className="title-link",FlickrTab.showOfflinePage()},3e3),photoUrl=photo.url_l||photo.url_m,photoRatio=photo.width_m/photo.height_m,tabRatio=tab.width/tab.height,img=document.getElementById("thumbnail-image"),img.onload=function(){fTitle.className="title-link",clearTimeout(offlineCheck),FlickrTab.queueJob("updateHistory",photo)},img.src=photoUrl,pathAlias=photo.pathalias||photo.owner,link=document.getElementById("thumbnail-link"),link.href="https://www.flickr.com/photos/"+pathAlias+"/"+photo.id,photo.exploreDay&&(link.href+="/in/explore-"+photo.exploreDay),tabRatio>photoRatio&&(link.style.backgroundPosition="top center"),link.style.backgroundImage="url("+photoUrl+")",fTitle=document.getElementsByClassName("title-link")[0],fTitle.href=link.href,fTitle.innerText=photo.title,iframe=document.createElement("iframe"),iframe.src="https://www.flickr.com/photos/"+pathAlias+"/"+photo.id+"/embedded/"+this.ywaParams,iframe.frameBorder=0,iframe.allowFullscreen="",iframe.scrolling="no",window.addEventListener("message",receiveMessage,!1);var counter=0;this.photoDiv.insertBefore(iframe,link),hasPhotoToDisplay=!0,log("iframe url set")},toggleHistoryThumbnails:function(e){var deltaX,deltaY,keydownCode,wheelEvent=!1,keyEvent=!1,registeredKeyCodes=[38,40,32];if("mousewheel"===e.type){if(deltaX=e.wheelDeltaX,deltaY=e.wheelDeltaY,Math.abs(deltaX)>Math.abs(deltaY))return;wheelEvent=!0}else if("keydown"===e.type){if(keydownCode=e.which,registeredKeyCodes.indexOf(keydownCode)<=-1)return;keyEvent=!0}var el=document.getElementsByClassName("history")[0],photoEl=document.getElementById("photo");if(!((wheelEvent&&0>deltaY||keyEvent&&38===keydownCode)&&el.className.indexOf("history-displayed")>-1||(wheelEvent&&deltaY>0||keyEvent&&40===keydownCode)&&el.className.indexOf("history-displayed")<=-1)){if(el.className.indexOf("history-displayed")<=-1)return el.className+=" history-displayed",void(photoEl.className+=" history-displayed");el.className=el.className.replace(" history-displayed",""),photoEl.className=photoEl.className.replace(" history-displayed","")}},renderHistoryPhoto:function(e){var i,el=e.currentTarget,photo=JSON.parse(el.getAttribute("data-history-photo")),iframe=document.getElementsByTagName("iframe")[0],hidden=document.getElementsByClassName("hide");for(i=0;i<hidden.length;i++)hidden[i].className=hidden[i].className.replace(" hide","");iframe.remove(),this.renderLiveTab(photo,this.renderRandomPhoto.bind(this))},renderHistoryThumbnails:function(){var photo,photoUrl,historyEl,photos=JSON.parse(localStorage.getItem(HISTORY)),el=document.getElementsByClassName("history-thumbnail")[0],html="";if(photos)for(var i=0;i<photos.length;i++)photo=photos[i],photo.title||(photo.title=chrome.i18n.getMessage("noTitle")),photoUrl=photo.url_l||photo.url_m,historyEl=document.createElement("div"),historyEl.className="history-thumbnail-item",historyEl.setAttribute("data-history-photo",JSON.stringify(photo)),historyEl.addEventListener("click",this.renderHistoryPhoto.bind(this)),html='<div class="history-thumbnail-item-item" style="background-image:url('+photoUrl+');">',photo.title&&(html+='<div class="history-thumbnail-item-item-title">'+photo.title+"</div>"),html+="</div>",historyEl.innerHTML=html,el.appendChild(historyEl)},initHistory:function(){var el=document.getElementsByClassName("history-nav")[0],historyOverlay=document.getElementsByClassName("history-displayed-overlay")[0];el.addEventListener("click",this.toggleHistoryThumbnails),document.addEventListener("mousewheel",this.toggleHistoryThumbnails),document.addEventListener("keydown",this.toggleHistoryThumbnails),historyOverlay.addEventListener("click",this.toggleHistoryThumbnails),this.renderHistoryThumbnails()},queueJob:function(func){var args=Array.prototype.slice.call(arguments);args.shift(),chrome.runtime.sendMessage({func:func,args:args},function(response){log("[Q]",response)})},setYWAParams:function(){if(chrome&&chrome.runtime&&chrome.runtime.getManifest){var manifest=chrome.runtime.getManifest();this.ywaParams=this.ywaParams+"&v="+manifest.version}}},randInt=function(max){return Math.floor(Math.random()*max)},log=function(){},DEBUG&&(log=function(){var args,time;args=1<=arguments.length?[].slice.call(arguments,0):[],time=(new Date%6e4/1e3).toFixed(3),args.unshift(time),console.log.apply(console,args)})("begin page load")}}).call(this);